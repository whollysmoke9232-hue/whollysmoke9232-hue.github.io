---
layout: layout.njk
---

<style>
  /* Page transition animation - v2 */
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateX(20px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  @keyframes fadeOut {
    from {
      opacity: 1;
      transform: translateX(0);
    }
    to {
      opacity: 0;
      transform: translateX(-20px);
    }
  }

  .book-content {
    animation: fadeIn 0.7s ease-in-out;
  }

  .book-content.page-exit {
    animation: fadeOut 0.5s ease-in-out;
  }

  /* Respect user's motion preferences */
  @media (prefers-reduced-motion: reduce) {
    .book-content,
    .book-content.page-exit {
      animation: none;
    }
  }

  /* Book header styles */
  .book-header {
    text-align: center;
    margin-bottom: 2rem;
    margin-top: 0.5rem;
    padding-bottom: 1rem;
    padding-top: 0;
    border-bottom: 2px solid #e0e0e0;
  }

  .chapter-title {
    margin: 0 0 0.5rem 0;
    color: #333;
  }

  .chapter-title a {
    color: #333;
    text-decoration: none;
    transition: color 0.2s;
  }

  .chapter-title a:hover {
    color: #4a90e2;
  }

  .chapter-subtitle {
    font-style: italic;
    color: #666;
    font-size: 0.9em;
    margin-top: 0.5rem;
  }

  .reading-mode-toggle {
    text-align: center;
    margin: 0.5rem 0;
    padding: 0.5rem;
    font-size: 0.85rem;
    color: #888;
  }

  .reading-mode-toggle a {
    color: #999;
    text-decoration: none;
    border-bottom: 1px dashed #ccc;
  }

  .reading-mode-toggle a:hover {
    color: #666;
    border-bottom-color: #666;
  }

  /* Chapter navigation */
  .chapter-nav-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 2px solid #e0e0e0;
    gap: 1rem;
  }

  .chapter-nav-btn {
    display: inline-block;
    padding: 0.5rem 1rem;
    background: #4a90e2;
    color: white;
    text-decoration: none;
    border-radius: 4px;
    font-size: 0.85rem;
    font-weight: 500;
    transition: transform 0.2s ease, background-color 0.2s ease;
    text-align: center;
  }

  .chapter-nav-btn:hover {
    transform: scale(1.1);
    background: #357abd;
  }

  .chapter-nav-disabled {
    background: #ccc;
    cursor: not-allowed;
    pointer-events: none;
  }

  @media (max-width: 768px) {
    .chapter-nav-container {
      flex-direction: column;
    }
    .chapter-nav-btn {
      width: 100%;
    }
  }
</style>

<div class="book-content">
  {% set tagList = [] %}
  {% if tags %}
    {% if tags is string %}
      {% set tagList = [tags] %}
    {% elif tags is array %}
      {% set tagList = tags %}
    {% endif %}
  {% endif %}
  {% set isFracturedLight = "fractured-light" in tagList %}
  {% set isMargins = "margins-where-god-begins" in tagList %}
  {% set bookCollection = collections.fracturedLight if isFracturedLight else collections.marginsBook %}
  {% set continuousUrl = "/stories/fractured-light/" if isFracturedLight else "/stories/margins-where-god-begins/" %}
  {% set tocUrl = "/books/fractured-light/toc/" if isFracturedLight else "/books/margins-where-god-begins/toc/" %}
  {% set contentsUrl = "/books/fractured-light/" if isFracturedLight else "/books/margins-where-god-begins/" %}
  {% set bookTitle = "Fractured Light" if isFracturedLight else "Margins: Where God Begins" %}

  <!-- Reading mode toggle -->
  <div class="reading-mode-toggle">
    <a href="{{ continuousUrl }}">Prefer continuous reading?</a>
  </div>

  <!-- Book header with TOC link -->
  <header class="book-header">
    <p style="margin: 0 0 0.5rem 0; font-size: 0.75rem; color: #999; text-transform: uppercase; letter-spacing: 0.05em;">
      <a href="{{ contentsUrl }}" style="color: inherit; text-decoration: none;">{{ bookTitle }}</a>
    </p>
    <h1 class="chapter-title">
      <a href="{{ tocUrl }}">{{ title }}</a>
    </h1>
    {% if chapterSubtitle %}
      <p class="chapter-subtitle">{{ chapterSubtitle }}</p>
    {% endif %}
  </header>

  <!-- Main chapter content -->
  <main class="main-page">
    {{ content | safe }}
  </main>

  <!-- Chapter navigation -->
  <nav class="chapter-nav-container" aria-label="Chapter Navigation">
    <div>
      {% if bookCollection %}
        {% set previousPost = bookCollection | getPreviousCollectionItem(page) %}
        {% if previousPost %}
          <a href="{{ previousPost.url }}" class="chapter-nav-btn" id="prev-chapter-link">
            ← {{ previousPost.data.title }}
          </a>
        {% else %}
          <span class="chapter-nav-btn chapter-nav-disabled">
            ← No Previous
          </span>
        {% endif %}
      {% endif %}
    </div>

    <div>
      {% if bookCollection %}
        {% set nextPost = bookCollection | getNextCollectionItem(page) %}
        {% if nextPost %}
          <a href="{{ nextPost.url }}" class="chapter-nav-btn" id="next-chapter-link">
            {{ nextPost.data.title }} →
          </a>
        {% else %}
          <a href="{{ contentsUrl }}" class="chapter-nav-btn">
            Back to Contents
          </a>
        {% endif %}
      {% endif %}
    </div>
  </nav>
</div>

<script>
  // Add smooth page transition on navigation
  document.addEventListener('DOMContentLoaded', function() {
    const nextLink = document.getElementById('next-chapter-link');
    const prevLink = document.getElementById('prev-chapter-link');
    
    // Smooth transition function
    function smoothTransition(link) {
      if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
        const content = document.querySelector('.book-content');
        content.classList.add('page-exit');
        
        setTimeout(() => {
          window.location.href = link.href;
        }, 500);
      } else {
        window.location.href = link.href;
      }
    }
    
    // Click handlers with animation
    if (nextLink) {
      nextLink.addEventListener('click', function(e) {
        e.preventDefault();
        smoothTransition(nextLink);
      });
    }
    
    if (prevLink) {
      prevLink.addEventListener('click', function(e) {
        e.preventDefault();
        smoothTransition(prevLink);
      });
    }
    
    // Keyboard shortcuts (arrow keys)
    document.addEventListener('keydown', function(e) {
      // Left arrow = previous chapter
      if (e.key === 'ArrowLeft' && prevLink) {
        e.preventDefault();
        smoothTransition(prevLink);
      }
      // Right arrow = next chapter
      if (e.key === 'ArrowRight' && nextLink) {
        e.preventDefault();
        smoothTransition(nextLink);
      }
    });
  });
</script>


<footer class="site-footer">

  <hr />
  <p><small>&copy; {{ author }} — Grace in the Margins</small></p>
</footer>
