<script>
(function () {
  // Read query params from the browser URL
  const params = new URLSearchParams(window.location.search);
  const pathKey = params.get("path");
  const stepRaw = params.get("step");

  // If no path/step, do nothing (normal browsing)
  if (!pathKey || !stepRaw) return;

  const step = parseInt(stepRaw, 10);
  if (!Number.isFinite(step) || step < 1) return;

  // readingPaths injected at build time
  const readingPaths = {{ readingPaths | dump | safe }};
  const list = readingPaths[pathKey];

  if (!Array.isArray(list) || list.length === 0) return;

  // Normalize list items to objects: { url, title }
  const items = list.map(item => {
    if (typeof item === "string") return { url: item, title: "" };
    if (item && typeof item === "object") return { url: item.url, title: item.title || "" };
    return null;
  }).filter(Boolean);

  const idx = step - 1;
  const prev = idx > 0 ? items[idx - 1] : null;
  const next = idx < items.length - 1 ? items[idx + 1] : null;

  // Where to render the nav
  const mount = document.querySelector("[data-reading-path-nav]");
  if (!mount) return;

  function linkHtml(item, label) {
    if (!item || !item.url) return "";
    const sep = item.url.includes("?") ? "&" : "?";
    const href = item.url + sep + "path=" + encodeURIComponent(pathKey) + "&step=" + (label === "prev" ? idx : idx + 2);
    const text = item.title ? item.title : (label === "prev" ? "Previous" : "Next");
    return `<a href="${href}">${text}</a>`;
  }

  // Build nav HTML
  const prevHtml = prev ? `← ${linkHtml(prev, "prev")}` : "";
  const nextHtml = next ? `${linkHtml(next, "next")} →` : "";

  // Optional: Back to the path landing page (only if your readingPaths contains it as step 1, like begin does)
  const backToPath = (function(){
    // If your path landing page is always the first item, you can use it:
    // const first = items[0];
    // return first && first.url ? first.url : null;

    // OR: if you want Begin specifically when pathKey is bondage-and-release, set it here:
    if (pathKey === "bondage-and-release") return "/bondage-and-release/";
    if (pathKey === "begin") return "/begin/";
    return null;
  })();

  mount.innerHTML = `
    <nav style="display:flex; justify-content:space-between; gap:1rem; margin-top:3rem; font-weight:bold;">
      <div>${prevHtml}</div>
      <div style="text-align:center;">${backToPath ? `<a href="${backToPath}">Back</a>` : ""}</div>
      <div>${nextHtml}</div>
    </nav>
  `;
})();
</script>
