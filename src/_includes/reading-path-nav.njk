{# Deterministic Reading Path Navigation (client-side)
   Source of truth:
   - ?path=
   - default = begin
#}

<div id="reading-path-nav" style="margin-top:3rem;"></div>

<script>
(function () {
  const mount = document.getElementById("reading-path-nav");
  if (!mount) return;

  const readingPaths = {{ readingPaths | dump | safe }};
  const params = new URLSearchParams(window.location.search);

  // DEFAULT TO BEGIN
  const pathKey = params.get("path") || "begin";

  function normPath(p) {
    if (!p) return "/";
    if (p[0] !== "/") p = "/" + p;
    if (!p.endsWith("/")) p += "/";
    return p;
  }

  function normItem(it) {
    if (typeof it === "string") return { url: normPath(it), title: it };
    if (it && typeof it === "object" && it.url) {
      return { url: normPath(it.url), title: it.title || it.url };
    }
    return null;
  }

  const rawItems = readingPaths[pathKey];
  if (!Array.isArray(rawItems)) return;

  const items = rawItems.map(normItem).filter(Boolean);
  const currentUrl = normPath(window.location.pathname);

  const idx = items.findIndex(it => it.url === currentUrl);
  if (idx === -1) return;

  const prev = idx > 0 ? items[idx - 1] : null;
  const next = idx < items.length - 1 ? items[idx + 1] : null;

  function landingHref(k) {
    if (k.startsWith("start-here-")) return "/start-here/";
    if (k.startsWith("hearing-god-")) return "/hearing-god/";
    if (k.startsWith("you-are-not-alone-")) return "/youre-not-alone/";
    return "/" + k + "/";
  }

  function landingLabel(k) {
    if (k.startsWith("start-here-")) return "Start Here";
    if (k.startsWith("hearing-god-")) return "Hearing God";
    if (k.startsWith("you-are-not-alone-")) return "You're Not Alone";
    return k.replace(/-/g, " ");
  }

  function hrefWithPath(url) {
    const u = new URL(url, window.location.origin);
    u.searchParams.set("path", pathKey);
    return u.pathname + u.search;
  }

  const centerHref = landingHref(pathKey);
  const centerLabel = landingLabel(pathKey);

  mount.innerHTML = `
    <hr style="margin:2.5rem 0;">
    <nav style="
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:0.9rem;
      font-weight:normal;
      line-height:1.4;
    ">
      <div style="max-width:40%;">
        ${prev ? `← <a href="${hrefWithPath(prev.url)}">Back to ${prev.title}</a>` : ""}
      </div>

      <div style="
        text-align:center;
        font-size:0.82rem;
        color:#666;
        padding:0 1rem;
        white-space:nowrap;
      ">
        <a href="${centerHref}" style="color:inherit; text-decoration:none;">
          Return to ${centerLabel}
        </a>
      </div>

      <div style="max-width:40%; text-align:right;">
        ${next ? `<a href="${hrefWithPath(next.url)}">Next ${next.title}</a> →` : ""}
      </div>
    </nav>
  `;

  const subtitleMount = document.getElementById("reading-path-subtitle");
  if (subtitleMount) {
    subtitleMount.innerHTML = `
      <a href="${centerHref}" style="text-decoration:none; color:inherit;">
        ${centerLabel}
      </a>
    `;
  }
})();
</script>
